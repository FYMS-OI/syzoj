<% this.title = '首页'; %>
<% include header %>
<% include util %>

<script src="<%- lib('vue/2.5.21/vue.min.js') %>"></script>
<% include quote_content %>
<% include quote_container %>

<div class="padding">
  <div class="ui three column grid">
    <div class="eleven wide column">
      <h4 class="ui top attached block header"><i class="fad fa-info"></i>公告</h4>
      <div class="ui bottom attached segment">
        <table class="ui very basic table unstackable">
          <thead>
            <tr>
              <th>标题</th>
              <th>时间</th>
            </tr>
          </thead>
          <tbody>
            <% for (let item of notices) { %>
              <tr>
                <td><a href="<%= item.url %>"><%= item.title %></a></td>
                <td><%= item.date %></td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
      <h4 class="ui top attached block header"><i class="fad fa-signal-3"></i>排名</h4>
      <div class="ui bottom attached segment">
        <% if (ranklist.length) { %>
        <table class="ui very basic center aligned table unstackable" style="table-layout: fixed; ">
          <thead>
            <tr>
	            <th style="width: 50px; ">#</th>
	            <th style="width: 170px; ">用户名</th>
	            <th>个性签名</th>
            </tr>
          </thead>
          <script data-cfasync="false">
          var lineHeight = 0;
          (function () {
            var div = document.createElement('div');
            div.style.position = 'fixed';
            div.style.left = -10000;
            div.style.visibility = 'hidden';
            div.innerText = '测试，Test.';
            document.body.appendChild(div);
            lineHeight = div.clientHeight;
          })();
          </script>
          <tbody>
            <% let i = 0; %>
            <% for (let user of ranklist) { %>
              <% ++i; %>
                <tr>
                    <td><b><%= i %></b></td>
                    <td><a href="<%= syzoj.utils.makeUrl(['user', user.id]) %>"><%= user.username %></a><% if(user.tg_name && user.tg_color) { %> 
<div class="ui <%= user.tg_color %> label"><%= user.tg_name %></div>
<% } %> </td>
                    <td style="font-content">
                      <script id="user-infomation-script-<%= i %>" data-cfasync="false">
                      (function () {
                        var html = <%- serializejs(user.information) %>;
                        var elem = document.createElement('div');
                        elem.style = 'overflow: hidden; width: 100%; position: relative; ';
                        elem.style.maxHeight = lineHeight + 'px';
                        elem.innerHTML = html;
                        var imgs = Array.prototype.slice.call(elem.getElementsByTagName('img'));
                        for (var i in imgs) imgs[i].parentNode.removeChild(imgs[i]);
                        var script = document.getElementById('user-infomation-script-<%= i %>');
                        script.parentNode.replaceChild(elem, script);
                      })();
                      </script>
                    </td>
                </tr>
            <% } %>
          </tbody>
        </table>
        <% } else { %>
          <div style="text-align: center;">这里是空 der~</div>
        <% } %>
      </div>
    </div>
    <div class="right floated five wide column side_bar">
        <%
          let showCustomHitokoto = syzoj.utils.allowedSeeingQuote(user);
          let hitokotoTitle = showCustomHitokoto ? syzoj.config.custom_hitokoto.title : syzoj.config.custom_hitokoto.title_original;
          let hitokotoUrl = showCustomHitokoto ? syzoj.utils.makeUrl(['api', 'quote']) : 'https://v1.hitokoto.cn/?c=a';
        %>
        <h4 class="ui top attached block header"><i class="fad fa-quote-left"></i><%= hitokotoTitle %></h4>
        <div id="quote-container" class="ui bottom attached segment">
          <quote-container url="<%= hitokotoUrl %>" :is-custom="<%= JSON.stringify(showCustomHitokoto) %>"></quote-container>
        </div>
        <script>
          let appHitokoto = new Vue({
            el: '#quote-container'
          });
        </script>
      <h4 class="ui top attached block header"><i class="fad fa-rss"></i>最近更新</h4>
      <div class="ui bottom attached segment">
	<table class="ui very basic center aligned table">
          <thead>
            <tr>
              <th width="70%">题目</th>
              <th width="30%">更新时间</th>
            </tr>
	  </thead>
	  <tbody>
	    <% for (let problem of problems) { %>
	    <tr>
	      <td><a href="<%= syzoj.utils.makeUrl(['problem', problem.id]) %>"><%= problem.title %></a></td>
	      <td><%= problem.time %></td>
	    </tr>
	    <% } %>
	  </tbody>
	</table>
      </div>
      <% if (todoList) { %>
      <h4 class="ui top attached block header"><i class="fad fa-tasks"></i>任务计划</h4>
      <div class="ui bottom attached segment">
          <div class="todo_list">
              <% for (let problem of todoList) { %>
                <div class="todo_list_item" data-problem="<%= problem.id %>">
                  <div style="text-align: center;">
                    <% let accepted = false; %>
                    <% if (problem.judge_state) { %>
                      <% if (problem.judge_state.status === 'Accepted') accepted = true; %>
                      <a href="<%= syzoj.utils.makeUrl(['submission', problem.judge_state.id]) %>">
                        <span class="status <%= problem.judge_state.status.toLowerCase().split(' ').join('_') %>">
                          <i class="fad <%= icon[problem.judge_state.status] || 'times' %> fa-fw"></i>
                        </span>
                      </a>
                    <% } else { %>
                      <i class="fad fa-minus fa-fw" style="color: #999;"></i>
                    <% } %>
                  </div>
                  <div style="text-align: left;">
                    <a href="<%= syzoj.utils.makeUrl(['problem', problem.id]) %>"><%= problem.id + '. ' + problem.title %></a>
                  </div>
                  <div style="text-align: center;">
                    <a class="button_todo_list_remove" data-content="<%= accepted ? '完成任务' : '从任务计划中删除' %>" href="javascript:void(0);">
                      <i class="<%= accepted ? 'check' : 'remove' %> icon"></i>
                    </a>
                  </div>
                </div>
              <% } %>
              <% if (!todoList.length) { %>
                <div style="text-align: center;">这里是空 der~</div>
              <% } %>
          </div>
      </div>
      <style type="text/css">
        .todo_list {
          margin-left: .125em;
          margin-right: .125em;
        }
        .todo_list_item {
          display: flex;
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
        .todo_list_item:not(:first-child) {
          margin-top: .75em;
        }
        .todo_list_item div:nth-child(2) {
          margin-left: .5em;
          margin-right: .5em;
          flex-grow: 1;
          flex-shrink: 1;
        }
        .button_todo_list_remove i {
          margin: 0 !important;
          color: #666;
          transition: linear color 0.15s 0s;
        }
        .button_todo_list_remove:hover i.check.icon {
          color: #21aa45;
        }
        .button_todo_list_remove:hover i.remove.icon {
          color: #db2828;
        }
      </style>
      <script type="text/javascript">
        $('.todo_list').on('click', '.button_todo_list_remove', function() {
          var $item = $(this).parents('.todo_list_item');
          var problem_id = $item.attr('data-problem');
          $.ajax({
            method: 'POST',
            url: '/api/todo_list/remove/' + problem_id,
            success: function(data) {
              if (data.error) {
                alert(data.error);
              } else {
                $item.transition('fade left', {
                  onComplete: function() {
                    $item.remove();
                    if (!$('.todo_list_item').length) {
                      $('.todo_list').append(
                        $('<div>').css('text-align', 'center')
                          .text('这里是空 der~')
                      );
                    }
                  }
                });
              }
            },
            error: function(xhr) {
              alert(xhr.responseText);
            }
          });
        });
        $(function() {
          $('.button_todo_list_remove').popup({
            position: 'top center'
          });
        });
      </script>
      <% } %>
        <% if (fortune) { %>
        <%  let color;
            if (fortune.fortune.indexOf('吉') != -1) color = '#0ccf00';
            else if (fortune.fortune.indexOf('凶') != -1) color = '#f25e65';
            else color = '#444';
        %>
        <h4 class="ui top attached block header"><i class="fad fa-magic"></i>今日运势</h4>
        <div class="ui bottom attached segment">
            <div style="height: 15px; "></div>
            <div class="ui two column center aligned padded grid">
                <div class="one column row">
                    <div style="text-align: center; ">
                        <div style="color: <%= color %>; font-size: 49px;"><%- (user.sex == -1 ? '♀ ' : '♂ ') + fortune.fortune + (user.sex == 1 ? ' <span style="transform: scaleX(-1); display: inline-block; ">♂</span>' : ' ♀') %></div>
                    </div>
                </div>
                <div class="two column row">
                    <div class="column">
                        <div style="color: #0ccf00; ">
                            <% if (fortune.good.length) { %>
                            <strong>宜：</strong><%= fortune.good[0].title %>
                            <br>
                            <span style="color: #888; font-size: 0.7em; "><%= fortune.good[0].detail %></span>
                            <div style="margin-top: 10px; "></div>
                            <strong>宜：</strong><%= fortune.good[1].title %>
                            <br>
                            <span style="color: #888; font-size: 0.7em; "><%= fortune.good[1].detail %></span>
                            <% } else { %>
                            <strong>诸事不宜<br>
                            </strong>
                            <% } %>
                        </div>
                    </div>
                    <div class="column">
                        <div style="color: #f25e65; ">
                            <% if (fortune.bad.length) { %>
                            <strong>忌：</strong><%= fortune.bad[0].title %>
                            <br>
                            <span style="color: #888; font-size: 0.7em; "><%= fortune.bad[0].detail %></span>
                            <div style="margin-top: 10px; "></div>
                            <strong>忌：</strong><%= fortune.bad[1].title %>
                            <br>
                            <span style="color: #888; font-size: 0.7em; "><%= fortune.bad[1].detail %></span>
                            <% } else { %>
                            <strong>万事皆宜<br>
                            </strong>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <% } %>
      <h4 class="ui top attached block header"><i class="fad fa-search"></i>搜索题目</h4>
      <div class="ui bottom attached segment">
        <form action="<%= syzoj.utils.makeUrl(['problems', 'search']) %>" method="get">
          <div class="ui search" style="width: 100%; ">
            <div class="ui left icon input" style="width: 100%; ">
              <input class="prompt" style="width: 100%; " type="text" placeholder="ID / 题目名 …" name="keyword">
              <i class="search icon"></i>
            </div>
            <div class="results" style="width: 100%; "></div>
          </div>
        </form>
      </div>
      <h4 class="ui top attached block header"><i class="fad fa-calendar"></i>近期比赛</h4>
      <div class="ui bottom attached <% if (!contests || !contests.length) { %>center aligned <% } %>segment">
        <% if (!contests || !contests.length) { %>
        还没有举行过任何比赛
        <% } else { %>
        <table class="ui very basic center aligned table">
          <thead>
            <tr>
              <th>比赛名称</th>
              <th>开始时间</th>
            </tr>
          </thead>
          <tbody>
            <% for (let contest of contests) { %>
            <%
              let now = syzoj.utils.getCurrentDate();
              let tag = '';
            %>
            <tr>
              <% if (now < contest.start_time) { %>
                <% tag = '<span class="ui header"><div class="ui mini red label">未开始</div></span>' %>
              <% } else if (now >= contest.start_time && now < contest.end_time) { %>
                <% tag = '<span class="ui header"><div class="ui mini green label">进行中</div></span>' %>
              <% } else { %>
                <% tag = '<span class="ui header"><div class="ui mini grey label">已结束</div></span>' %>
              <% } %>
              <td><a href="<%= syzoj.utils.makeUrl(['contest', contest.id]) %>"><%= contest.title %> <%- tag %></a></td>
              <td><%= syzoj.utils.formatDate(contest.start_time) %></td>
            </tr>
            <% } %>
          </tbody>
        </table>
        <% } %>
      </div>
      <% if (typeof links !== 'undefined' && links && links.length) { %>
      <h4 class="ui top attached block header font-content"><i class="fad fa-link"></i>友情链接</h4>
      <div class="ui bottom attached segment">
        <ul style="margin: 0; padding-left: 20px; ">
          <% for (let link of links) { %>
            <li><a href="<%= link.url %>"><%= link.title %></a></li>
          <% } %>
        </ul>
      </div>
      <% } %>
    </div>
  </div>
</div>

<script>
$(function () {
  $('.ui.search').search({
    debug: true,
    apiSettings: {
      url: '/api/v2/search/problems/{query}',
      cache: false
    },
    fields: {
      title: 'name'
    }
  });
});
</script>

<style type="text/css">
  .side_bar .ui.block.header i.icon {
    font-size: 1em;
    vertical-align: initial;
  }
</style>

<script type="text/javascript">
  (function() {
    const storageKey = 'syzoj_sidebar';
    var $sidebar = $('.side_bar');
    var $headers = $sidebar.find(".ui.top.attached.block.header");
    var config = null;

    // load the config
    try {
      config = JSON.parse(localStorage.getItem(storageKey));
      if (!config || typeof config !== 'object') config = {};
    } catch (err) {
      config = {};
    }

    function saveConfig() {
      localStorage.setItem(storageKey, JSON.stringify(config));
    }

    // apply saved config and register events
    $headers.each(function(i, header) {
      var $header = $(header);
      var $segment = $header.next(".ui.bottom.attached.segment");
      var name = $header.text().trim();
      var hidden = false;

      $header.css('cursor', 'pointer');

      if (name in config) {
        if (config[name] === "hide") {
          $header.removeClass("top attached");
          $segment.hide();
          hidden = true;
        }
      } else {
        config[name] = "show";
      }

      $header.click(function() {
        if (hidden) {
          $segment.queue(function(next) {
            $header.addClass("top attached");
            next();
          }).slideDown();
        } else {
          $segment.slideUp(function() {
            $header.removeClass("top attached");
          });
        }
        hidden = !hidden;
        config[name] = hidden ? "hide" : "show";
        saveConfig();
      });
    });

    saveConfig();

  })();
</script>
<% include footer %>
